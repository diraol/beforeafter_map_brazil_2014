<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta content="initial-scale=1.0, user-scalable=no" name="viewport">
  <meta charset="utf-8">
  <!--link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.css" /-->
  <!--script src="http://libs.cartocdn.com/cartodb.js/v3/cartodb.js"></script-->
  <link rel="stylesheet" href="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/themes/css/cartodb.css" />
  <script src="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/cartodb.js"></script>
  <!--script src="http://maps.googleapis.com/maps/api/js?sensor=false"></script-->
  <style>
    html, body {width:100%; height:100%; padding: 0; margin: 0;}
    #mapa { width: 100%; height:100%; background: white;}
  </style>

  <script type="infowindow/html" id="infowindow_template_nacional">
    <div class="cartodb-tooltip-content-wrapper">
      <div class="cartodb-tooltip-content">
        <h5>{{estado}} - {{cargo}}</h5>
        <h6>{{num_urna_cand}} ({{partido}}) - {{valor_perc}}%</h6>
        <p>{{valor_abs}} votos</p>
        <p>Eleitorado do município:<br/> {{eleitorado}} eleitores</p>
      </div>
    </div>
  </script>
  <script type="infowindow/html" id="infowindow_template_estadual">
    <div class="cartodb-tooltip-content-wrapper">
      <div class="cartodb-tooltip-content">
        <h5>{{nome_ibge_com_acento}} ({{estado}}) - {{cargo}}</h5>
        <h6>{{num_urna_cand}} ({{partido}}) - {{valor_perc}}%</h6>
        <p>{{valor_abs}} votos</p>
        <p>Eleitorado do município:<br/> {{eleitorado}} eleitores</p>
      </div>
    </div>
  </script>
  <script>

    var cores_partidos = {
      'PT': "#dd3030",
      'PSB': "#ffba34",
      'PSDB': "#274fb3",
      'PSC': "#438438",
      'PSOL': "#ffc887",
      'PMDB': "#9fde71",
      'PSD': "#71afde",
      'DEM': "#00c0ff",
      'PSTU': "#f56bb9",
      'PRTB': "#c6c063",
      'PSDC': "#5155df",
      'PDT': "#ff5569",
      'PTdoB': "#77bc26",
      'PR': "#484b73",
      'PPL': "#194423",
      'PCdoB': "#aa7800",
      'PTC': "#0074aa",
      'PROS': "#ff7200",
      'PP': "#0c2470",
      'PPS': "#974d36",
      'PTB': "#202020",
      'PTN': "#255b57",
      'PRP': "#0adfcd",
      'PSL': "#7ebaae",
      'SDD': "#855a9e",
      'PHS': "#d4ccb2"
    }

    //TODO
    var estados = {
      'BR': {
        center: [-17.987239525774244,-55.51463843650],
        zoom: 4,
      },
      'AC': {
        center: [-10.982749041623823, -70.68940429687499],
        zoom: 6,
      },
      'AL': {
        center: [-11.084500864717155, -36.6009521484375],
        zoom: 7,
      },
      'AP': {
        center: [1.463325357489324, -52.588427734375],
        zoom: 7,
      },
      'AM': {
        center: [-8.561535597066094, -66.35791015625],
        zoom: 5,
      },
      'BA': {
        center: [-14.393038580274138, -42.146923828125],
        zoom: 6,
      },
      'CE': {
        center: [-5.50735844762961, -39.861767578125],
        zoom: 7,
      },
      'DF': {
        center: [-16.065822729893808, -47.819366455078125],
        zoom: 9,
      },
      'ES': {
        center: [-20.43051299702225, -40.5889892578125],
        zoom: 7,
      },
      'GO': {
        center: [-17.877960306212524, -49.361572265625],
        zoom: 6
      },
      'MA': {
        center: [-6.766007882805485, -45.37353515625],
        zoom: 6
      },
      'MG': {
        center: [-19.650219977065594, -45.42720703125],
        zoom: 6,
      },
      'MT': {
        center: [-13.175771224423402, -55.83251953125],
        zoom: 6,
      },
      'MS': {
        center: [-21.396123272467616, -54.82177734374999],
        zoom: 6,
      },
      'PA': {
        center: [-7.653079918274038, -54.88818359374999],
        zoom: 5,
      },
      'PB': {
        center: [-8.6425975109493255, -36.7767333984375],
        zoom: 7,
      },
      'PR': {
        center: [-26.627044746156027, -51.65771484375],
        zoom: 6,
      },
      'PE': {
        center: [-10.352823015039577, -38.06762695312499],
        zoom: 6,
      },
      'PI': {
        center: [-8.044498849647323, -42.86865234375],
        zoom: 6,
      },
      'RJ': {
        center: [-23.494179051660386, -43.06103515625],
        zoom: 7,
      },
      'RN': {
        center: [-7.347174076651375, -36.6778564453125 ],
        zoom: 7,
      },
      'RS': {
        center: [-31.57786119581683, -53.618896484375],
        zoom: 6,
      },
      'RO': {
        center: [-12.398042159726009, -63.12744140625],
        zoom: 6,
      },
      'RR': {
        center: [0.2332268264771233, -62.34765625],
        zoom: 6,
      },
      'SC': {
        center: [-28.364017546608678, -51.065576171875],
        zoom: 7,
      },
      'SP': {
        center: [-24.736945920943844,-49.30263671875],
        zoom: 6,
      },
      'SE': {
        center: [-10.760607953624762, -37.66724853515625],
        zoom: 8,
      },
      'TO': {
        center: [-10.48227924591501, -48.306884765625],
        zoom: 6,
      }
    };

    function getParameterByName(name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
            results = regex.exec(location.search);
        return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
    }

    window.map = null;

    function init(){

      var cargo = getParameterByName("cargo") == "" ? "presidente" : getParameterByName("cargo"),
          uf = getParameterByName("uf") == "" ? "BR" : getParameterByName("uf").toUpperCase(),
          nurna = getParameterByName("nurna");


      var query = "",
          cartocss = "",
          template = "infowindow_template_nacional";

      console.log(cargo, uf, nurna);

      // 'If' que monta a query que será efetuada
      if ((cargo == "" || cargo == "presidente") && (uf == "" || uf == "BR") && (nurna == "")) {
        // Cargo Presidencial
        // Sem estado definido - mostra mapa nacional com divisões e totalizações estaduais
        // Sem nurna - Vencedor de cada estado
        query = "SELECT\
                   R.cartodb_id,\
                   E.the_geom_webmercator,\
                   E.estado,\
                   E.eleitorado_2014 as eleitorado,\
                   'Presidente' as cargo,\
                   R.num_urna_cand,\
                   R.turno,\
                   R.valor_abs,\
                   R.valor_perc,\
                   R.partido\
                 FROM\
                   urna2014.resultado_2014 R,\
                   estadao.poligonosestados E\
                 WHERE\
                   R.estado = E.uf AND\
                   R.cod_tse_municipio is null\
                 ORDER BY\
                   valor_perc";
        template = "infowindow_template_nacional";
        console.log("Pres - Sem UF (Geral) - sem Cand");
        console.log(query);
      } else if ((cargo == "" || cargo == "presidente") && (uf == "" || uf == "BR") && (nurna != "")) {
        // Cargo Presidencial
        // Sem estado definido - mostra mapa nacional com divisões e totalizações estaduais
        // Com nurna - Candidato selecionado - Mostra o "resultado geral" do candidato em cada estado
        query = "SELECT\
                   R.cartodb_id,\
                   E.the_geom_webmercator,\
                   E.estado,\
                   E.eleitorado_2014 as eleitorado,\
                   'Presidente' as cargo,\
                   R.num_urna_cand,\
                   R.turno,\
                   R.valor_abs,\
                   R.valor_perc,\
                   R.partido\
                 FROM\
                   urna2014.resultado_2014 R,\
                   estadao.poligonosestados E\
                 WHERE\
                   R.estado = E.uf AND\
                   R.cargo_cand = 1 AND\
                   R.cod_tse_municipio is null AND\
                   R.num_urna_cand = " + nurna;
        template = "infowindow_template_nacional";
        console.log("Pres - Sem UF (Geral) - com Cand");
      } else if ((cargo == "" || cargo == "presidente") && (uf != "" && uf != "BR") && (nurna == "")) {
        // Cargo Presidencial
        // Com estado definido - mostra o mapa do estado, com as divisões municipais do estado, totalizado por município
        // Sem nurna - Vencedor em cada município
        // TODO: Acertar o zoom e localização (centro) de cada estado
        query = "SELECT\
                   R.cartodb_id,\
                   M.the_geom_webmercator,\
                   M.nome_ibge_com_acento,\
                   M.estado,\
                   M.eleitorado,\
                   'Presidente' as cargo,\
                   R.num_urna_cand,\
                   R.turno,\
                   R.valor_abs,\
                   R.valor_perc,\
                   R.partido\
                 FROM\
                   urna2014.resultado_2014 R,\
                   estadao.municipios_tse M\
                 WHERE\
                   R.estado = '" + uf + "' AND\
                   M.estado = '" + uf + "' AND\
                   R.cargo_cand = 1 AND\
                   R.cod_tse_municipio = M.cod_tse\
                 ORDER BY\
                   valor_perc";
        template = "infowindow_template_estadual";
        console.log("Pres - Com UF (estadual) - Sem Cand");
      } else if ((cargo == "" || cargo == "presidente") && (uf != "" && uf != "BR") && (nurna != "")) {
        // Cargo Presidencial
        // Com estado definido - mostra o mapa do estado, com as divisões municipais do estado, totalizado por município
        // Com nurna - Candidato selecionado - Mostra o "resultado geral" do candidato em cada município
        // TODO: Acertar o zoom e localização (centro) de cada estado
        query = "SELECT\
                   R.cartodb_id,\
                   M.the_geom_webmercator,\
                   M.nome_ibge_com_acento,\
                   M.estado,\
                   M.eleitorado,\
                   'Presidente' as cargo,\
                   R.num_urna_cand,\
                   R.turno,\
                   R.valor_abs,\
                   R.valor_perc,\
                   R.partido\
                 FROM\
                   urna2014.resultado_2014 R,\
                   estadao.municipios_tse M\
                 WHERE\
                   R.estado = '" + uf + "' AND\
                   M.estado = '" + uf + "' AND\
                   R.cargo_cand = 1 AND\
                   R.cod_tse_municipio = M.cod_tse AND\
                   R.num_urna_cand = '" + nurna + "'";
        template = "infowindow_template_estadual";
        console.log("Pres - Com UF (estadual) - Com Cand");
      } else if ((cargo == "governador") && (uf == "" || uf == "SP") && (nurna == "")) {
        // Cargo Governador
        // Sem estado definido (ou SP, que é Default) - mostra o mapa do estado, com as divisões municipais do estado, totalizado por município
        // Sem nurna - Vencedor em cada município
        // TODO: Acertar o zoom e localização (centro) de cada estado
        query = "SELECT\
                   R.cartodb_id,\
                   M.the_geom_webmercator,\
                   M.nome_ibge_com_acento,\
                   M.estado,\
                   M.eleitorado,\
                   'Governador' as cargo,\
                   R.num_urna_cand,\
                   R.turno,\
                   R.valor_abs,\
                   R.valor_perc,\
                   R.partido\
                 FROM\
                   urna2014.resultado_2014 R,\
                   estadao.municipios_tse M\
                 WHERE\
                   R.estado = 'SP' AND\
                   M.estado = 'SP' AND\
                   R.cargo_cand = 3 AND\
                   R.cod_tse_municipio = M.cod_tse\
                 ORDER BY\
                   valor_perc";
        template = "infowindow_template_estadual";
        console.log("Gov - Sem UF (SP) - Sem Cand");
      } else if ((cargo == "governador") && (uf == "" || uf == "SP") && (nurna != "")) {
        // Cargo Governador
        // Sem estado definido (ou SP, que é Default) - mostra o mapa do estado, com as divisões municipais do estado, totalizado por município
        // Com nurna - Candidato selecionado - Mostra o "resultado geral" do candidato em cada município
        // TODO: Acertar o zoom e localização (centro) de cada estado
        query = "SELECT\
                   R.cartodb_id,\
                   M.the_geom_webmercator,\
                   M.nome_ibge_com_acento,\
                   M.estado,\
                   M.eleitorado,\
                   'Governador' as cargo,\
                   R.num_urna_cand,\
                   R.turno,\
                   R.valor_abs,\
                   R.valor_perc,\
                   R.partido\
                 FROM\
                   urna2014.resultado_2014 R,\
                   estadao.municipios_tse M\
                 WHERE\
                   R.estado = 'SP' AND\
                   M.estado = 'SP' AND\
                   R.cargo_cand = 3 AND\
                   R.cod_tse_municipio = M.cod_tse AND\
                   R.num_urna_cand = '" + nurna + "'";
        template = "infowindow_template_estadual";
        console.log("Gov - Sem UF (SP) - Com Cand");
      } else if ((cargo == "governador") && (uf != "") && (nurna == "")) {
        // Cargo Governador
        // Com estado definido - mostra o mapa do estado, com as divisões municipais do estado, totalizado por município
        // Sem nurna - Vencedor em cada município
        // TODO: Acertar o zoom e localização (centro) de cada estado
        query = "SELECT\
                   R.cartodb_id,\
                   M.the_geom_webmercator,\
                   M.nome_ibge_com_acento,\
                   M.estado,\
                   M.eleitorado,\
                   'Governador' as cargo,\
                   R.num_urna_cand,\
                   R.turno,\
                   R.valor_abs,\
                   R.valor_perc,\
                   R.partido\
                 FROM\
                   urna2014.resultado_2014 R,\
                   estadao.municipios_tse M\
                 WHERE\
                   R.estado = '" + uf + "' AND\
                   M.estado = '" + uf + "' AND\
                   R.cargo_cand = 3 AND\
                   R.cod_tse_municipio = M.cod_tse\
                 ORDER BY\
                   valor_perc";
        template = "infowindow_template_estadual";
        console.log("Gov - Com UF - Sem Cand");
      } else if ((cargo == "governador") && (uf != "") && (nurna != "")) {
        // Cargo Governador
        // Com estado definido - mostra o mapa do estado, com as divisões municipais do estado, totalizado por município
        // Com nurna - Candidato selecionado - Mostra o "resultado geral" do candidato em cada município
        // TODO: Acertar o zoom e localização (centro) de cada estado
        query = "SELECT\
                   R.cartodb_id,\
                   M.the_geom_webmercator,\
                   M.nome_ibge_com_acento,\
                   M.estado,\
                   M.eleitorado,\
                   'Governador' as cargo,\
                   R.num_urna_cand,\
                   R.turno,\
                   R.valor_abs,\
                   R.valor_perc,\
                   R.partido\
                 FROM\
                   urna2014.resultado_2014 R,\
                   estadao.municipios_tse M\
                 WHERE\
                   R.estado = '" + uf + "' AND\
                   M.estado = '" + uf + "' AND\
                   R.cargo_cand = 3 AND\
                   R.cod_tse_municipio = M.cod_tse AND\
                   R.num_urna_cand = '" + nurna + "'";
        template = "infowindow_template_estadual";
        console.log("Gov - Com UF - Com Cand");
      } else {
        //default query
        query = "SELECT\
                   R.cartodb_id,\
                   E.the_geom_webmercator,\
                   E.estado,\
                   E.eleitorado_2014,\
                   'Presidente' as cargo,\
                   R.num_urna_cand,\
                   R.turno,\
                   R.valor_abs,\
                   R.valor_perc,\
                   R.partido\
                 FROM\
                   urna2014.resultado_2014 R,\
                   estadao.poligonosestados E\
                 WHERE\
                   R.estado = E.estado AND\
                   R.cargo_cand = 1\
                 ORDER BY\
                   valor_perc";
        template = "infowindow_template_nacional";
        console.log("Pres - Sem UF (Geral) - sem Cand");
      }

      //Montagem do CartoCSS
      //  São 2 casos, o primeiro sem candidato definido que vai mostrar os líderes de cada área
      //  e o segundo com candidato definido, que vai mostrar um 'Choropleth' na região
      if (nurna == "") {
        cartocss = "#resultado_2014 {\
                            polygon-opacity: 0.5;\
                            line-color: #444;\
                            line-width: 0.1;\
                            line-opacity: 0.3;\
                          }\
                          #resultado_2014[partido='PBAN'] {\
                            polygon-fill: #A6CEE3;\
                          }\
                          #resultado_2014[partido='PBAR'] {\
                            polygon-fill: #1F78B4;\
                          }\
                          #resultado_2014[partido='PLAN'] {\
                            polygon-fill: #B2DF8A;\
                          }\
                          #resultado_2014[partido='PGAL'] {\
                            polygon-fill: #33A02C;\
                          }\
                          #resultado_2014[partido='PJAG'] {\
                            polygon-fill: #FB9A99;\
                          }\
                          #resultado_2014[partido='PARA'] {\
                            polygon-fill: #E31A1C;\
                          }\
                          #resultado_2014[partido='PKUW'] {\
                            polygon-fill: #FDBF6F;\
                          }"

      } else {
        cartocss = "#resultado_2014{\
                      polygon-fill: #FFFFB2;\
                      polygon-opacity: 0.8;\
                      line-color: #444;\
                      line-width: 1;\
                      line-opacity: 1;\
                    }\
                    #resultado_2014 [ valor_perc <= 76.05] {\
                       polygon-fill: #B10026;\
                    }\
                    #resultado_2014 [ valor_perc <= 29.4] {\
                       polygon-fill: #E31A1C;\
                    }\
                    #resultado_2014 [ valor_perc <= 24.21] {\
                       polygon-fill: #FC4E2A;\
                    }\
                    #resultado_2014 [ valor_perc <= 21.32] {\
                       polygon-fill: #FD8D3C;\
                    }\
                    #resultado_2014 [ valor_perc <= 19.15] {\
                       polygon-fill: #FEB24C;\
                    }\
                    #resultado_2014 [ valor_perc <= 16.51] {\
                       polygon-fill: #FED976;\
                    }\
                    #resultado_2014 [ valor_perc <= 11.82] {\
                       polygon-fill: #FFFFB2;\
                    }"
      }

      var layerUrl = 'http://grupoestado.cartodb.com/api/v2/viz/01de6de0-3f6b-11e4-8bbf-0e10bcd91c2b/viz.json';

      var subLayerOptions = {
              sql: query,
              cartocss: cartocss,
          }

      // initiate leaflet map
      map = new L.Map('mapa', {
        center: estados[uf]['center'],
        zoom: estados[uf]['zoom'],
        scrollWheelZoom: false
      });
      //map.on('click', function(e) { console.log("Lat, Lon : " + e.latlng.lat + ", " + e.latlng.lng) })

      cartodb.createLayer(map, layerUrl)
        .addTo(map)
        .on('done', function(layer) {
          layer.getSubLayer(0).set(subLayerOptions);
          var sublayer = layer.getSubLayer(0);
              sublayer.infowindow.set('template', $('#infowindow_template_nacional').html());
        }).on('error', function(err) {
          //log the error
          console.log(err);
        });

    }
  </script>
</head>
<body onload="init()">
  <div id="mapa" class="leaflet-container leaflet-fade-anim" style="position: relative; cursor: auto;" tabindex="0"> </div>
</body>
</html>
